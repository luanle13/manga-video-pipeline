{% extends "base.html" %}

{% block title %}Settings - Manga Video Pipeline{% endblock %}

{% block content %}
<h1>Pipeline Settings</h1>

<div class="card" style="max-width: 800px;">
    <h2>Configuration</h2>

    <form id="settingsForm">
        <!-- Daily Quota -->
        <div class="form-group">
            <label for="daily_quota">
                Daily Video Quota
                <span style="color: #666; font-weight: normal;">(1-10 videos per day)</span>
            </label>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <input type="range" id="daily_quota_slider" min="1" max="10"
                       value="{{ settings.daily_quota }}"
                       style="flex: 1;"
                       oninput="document.getElementById('daily_quota').value = this.value">
                <input type="number" id="daily_quota" name="daily_quota"
                       min="1" max="10" value="{{ settings.daily_quota }}"
                       style="width: 80px;"
                       oninput="document.getElementById('daily_quota_slider').value = this.value"
                       required>
            </div>
        </div>

        <!-- Voice Selection -->
        <div class="form-group">
            <label for="voice_id">TTS Voice</label>
            <select id="voice_id" name="voice_id" required>
                {% for voice in voices %}
                <option value="{{ voice.id }}"
                        {% if voice.id == settings.voice_id %}selected{% endif %}>
                    {{ voice.name }} ({{ voice.locale }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Tone -->
        <div class="form-group">
            <label for="tone">Narration Tone</label>
            <input type="text" id="tone" name="tone"
                   value="{{ settings.tone }}"
                   placeholder="e.g., engaging, professional, dramatic"
                   required>
            <small style="color: #666; display: block; margin-top: 0.5rem;">
                Describe the desired tone for the narration (e.g., "engaging and enthusiastic")
            </small>
        </div>

        <!-- Script Style -->
        <div class="form-group">
            <label for="script_style">Script Generation Style</label>
            <select id="script_style" name="script_style" required>
                <option value="detailed_review"
                        {% if settings.script_style == 'detailed_review' %}selected{% endif %}>
                    Detailed Review - Comprehensive analysis and commentary
                </option>
                <option value="summary"
                        {% if settings.script_style == 'summary' %}selected{% endif %}>
                    Summary - Brief overview of key events
                </option>
                <option value="chapter_walkthrough"
                        {% if settings.script_style == 'chapter_walkthrough' %}selected{% endif %}>
                    Chapter Walkthrough - Scene-by-scene narration
                </option>
            </select>
        </div>

        <!-- Manual Review Mode -->
        <div class="form-group">
            <label for="manual_review_mode">
                Manual Review Mode
            </label>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <input type="checkbox" id="manual_review_mode" name="manual_review_mode"
                       {% if settings.manual_review_mode %}checked{% endif %}
                       style="width: auto; height: 20px; cursor: pointer;">
                <span id="review_mode_label" style="color: {% if settings.manual_review_mode %}#4caf50{% else %}#666{% endif %};">
                    {% if settings.manual_review_mode %}Enabled{% else %}Disabled{% endif %}
                </span>
            </div>
            <small style="color: #666; display: block; margin-top: 0.5rem;">
                When enabled, videos will pause after rendering for manual review. You can download the video and choose when to upload to YouTube.
            </small>
        </div>

        <button type="submit" style="width: 100%;">Save Settings</button>
    </form>
</div>

<!-- Current Settings Info -->
<div class="card" style="max-width: 800px; margin-top: 1.5rem;">
    <h3>Current Configuration</h3>
    <table style="background: transparent;">
        <tr>
            <td><strong>Daily Quota:</strong></td>
            <td id="current-quota">{{ settings.daily_quota }} videos/day</td>
        </tr>
        <tr>
            <td><strong>Voice:</strong></td>
            <td id="current-voice">
                {% for voice in voices %}
                    {% if voice.id == settings.voice_id %}{{ voice.name }}{% endif %}
                {% endfor %}
            </td>
        </tr>
        <tr>
            <td><strong>Tone:</strong></td>
            <td id="current-tone">{{ settings.tone }}</td>
        </tr>
        <tr>
            <td><strong>Script Style:</strong></td>
            <td id="current-style">{{ settings.script_style }}</td>
        </tr>
        <tr>
            <td><strong>Manual Review:</strong></td>
            <td id="current-review-mode" style="color: {% if settings.manual_review_mode %}#4caf50{% else %}#666{% endif %};">
                {% if settings.manual_review_mode %}Enabled{% else %}Disabled{% endif %}
            </td>
        </tr>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load available voices
    let availableVoices = [];

    async function loadVoices() {
        try {
            const response = await fetch('/api/voices', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                availableVoices = data.voices;
            }
        } catch (error) {
            console.error('Error loading voices:', error);
        }
    }

    // Get CSRF token
    async function getCsrfToken() {
        // CSRF token is embedded in the page by the server
        // We need to fetch it from the settings page
        try {
            const response = await fetch('/settings', {
                credentials: 'include'
            });
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const csrfInput = doc.querySelector('input[name="csrf_token"]');
            return csrfInput ? csrfInput.value : null;
        } catch (error) {
            console.error('Error getting CSRF token:', error);
            return null;
        }
    }

    // Save settings
    async function saveSettings(event) {
        event.preventDefault();

        const submitButton = event.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';

        try {
            // Get CSRF token from cookie or generate new one
            const csrfToken = '{{ csrf_token }}';

            const formData = {
                daily_quota: parseInt(document.getElementById('daily_quota').value),
                voice_id: document.getElementById('voice_id').value,
                tone: document.getElementById('tone').value,
                script_style: document.getElementById('script_style').value,
                manual_review_mode: document.getElementById('manual_review_mode').checked,
                csrf_token: csrfToken
            };

            const response = await fetch('/api/settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                showToast('Settings saved successfully', 'success');

                // Update current settings display
                document.getElementById('current-quota').textContent = `${formData.daily_quota} videos/day`;

                const selectedVoice = availableVoices.find(v => v.id === formData.voice_id);
                if (selectedVoice) {
                    document.getElementById('current-voice').textContent = selectedVoice.name;
                }

                document.getElementById('current-tone').textContent = formData.tone;
                document.getElementById('current-style').textContent = formData.script_style;

                // Update manual review mode display
                const reviewModeEl = document.getElementById('current-review-mode');
                const reviewLabelEl = document.getElementById('review_mode_label');
                if (formData.manual_review_mode) {
                    reviewModeEl.textContent = 'Enabled';
                    reviewModeEl.style.color = '#4caf50';
                    reviewLabelEl.textContent = 'Enabled';
                    reviewLabelEl.style.color = '#4caf50';
                } else {
                    reviewModeEl.textContent = 'Disabled';
                    reviewModeEl.style.color = '#666';
                    reviewLabelEl.textContent = 'Disabled';
                    reviewLabelEl.style.color = '#666';
                }
            } else {
                showToast(data.detail || 'Failed to save settings', 'error');
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            showToast('Network error. Please try again.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Save Settings';
        }
    }

    // Update review mode label on change
    function updateReviewModeLabel() {
        const checkbox = document.getElementById('manual_review_mode');
        const label = document.getElementById('review_mode_label');
        if (checkbox.checked) {
            label.textContent = 'Enabled';
            label.style.color = '#4caf50';
        } else {
            label.textContent = 'Disabled';
            label.style.color = '#666';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadVoices();
        document.getElementById('settingsForm').addEventListener('submit', saveSettings);
        document.getElementById('manual_review_mode').addEventListener('change', updateReviewModeLabel);
    });
</script>
{% endblock %}
